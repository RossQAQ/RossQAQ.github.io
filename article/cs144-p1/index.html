<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Computer Network, 2024 Winter, p1 记录"><title>CS144-2024 Winter - Lab 1</title>
<link rel=canonical href=https://rossqaq.github.io/article/cs144-p1/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="CS144-2024 Winter - Lab 1"><meta property='og:description' content="Computer Network, 2024 Winter, p1 记录"><meta property='og:url' content='https://rossqaq.github.io/article/cs144-p1/'><meta property='og:site_name' content='Roses'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-05-12T00:00:00+00:00'><meta property='article:modified_time' content='2024-05-12T00:00:00+00:00'><meta name=twitter:title content="CS144-2024 Winter - Lab 1"><meta name=twitter:description content="Computer Network, 2024 Winter, p1 记录"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu57fe4ea25b3b752b8c24bca0d657f08c_427356_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>♉</span></figure><div class=site-meta><h1 class=site-name><a href=/>Roses</a></h1><h2 class=site-description>有限的时间，无尽的痛苦。</h2></div></header><ol class=menu-social><li><a href=https://space.bilibili.com/3078464 target=_blank title=Bilibili rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-bilibili" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a></li><li><a href=https://github.com/RossQAQ target=_blank title=Github rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href='https://music.163.com/playlist?id=109571638&amp;userid=93740300' target=_blank title=网易云音乐 rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-netease-music" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 4c-2.93 1.346-5 5.046-5 8.492C4 17 8 20 12 20s8-3 8-7c0-3.513-3.5-5.513-6-5.513S9 9 9 12c0 2 1.5 3 3 3s3-1 3-3c0-3.513-2-4.508-2-6.515.0-3.504 3.5-2.603 4-1.502"/></svg></a></li><li><a href=mailto:rossqaq@outlook.com target=_blank title=邮件 rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友情链接</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#总览>总览</a></li><li><a href=#开始>开始</a></li><li><a href=#按顺序恢复子串>按顺序恢复子串</a><ol><li><a href=#reassembler-内部应该存储什么>Reassembler 内部应该存储什么？</a></li><li><a href=#faqs>FAQs</a></li></ol></li><li><a href=#开发和-debug-建议>开发和 Debug 建议</a></li><li><a href=#提交>提交</a></li><li><a href=#源代码>源代码</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/cs144/ style=background-color:#2a9d8f;color:#fff>CS 144
</a><a href=/categories/finished/ style=background-color:#2a9d8f;color:#fff>施工完毕</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/article/cs144-p1/>CS144-2024 Winter - Lab 1</a></h2><h3 class=article-subtitle>Computer Network, 2024 Winter, p1 记录</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 12, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 7 分钟</time></div></footer></div></header><section class=article-content><h2 id=总览>总览</h2><p>介绍了 TCP 是<strong>可靠的有序字节流</strong>，简单介绍了它的地位。以下的 assignments 会基于不可靠的 datagram 来实现可靠的 TCP 协议。在未来的 labs，需要两个 lab 0 中的 ByteStream，一个用于发送数据，一个用于接收数据。</p><h2 id=开始>开始</h2><p>依然是使用 Minnow 库：</p><ol><li>确保提交了 checkpoint 0 的代码，不要更改 <code>src</code> 之外的文件，以及 <code>webget.cc</code>。</li><li><code>git fetch</code> 来获取最新的 lab assignments</li><li><code>git merge name-of-cs144-origin/check1-startercode</code> 来下载 checkpoint 1 的初始代码</li><li>确保 build 路径正确设置</li><li>编译 <code>cmake --build build</code></li><li>打开并且编辑 <code>writeups/check1.md</code></li></ol><h2 id=按顺序恢复子串>按顺序恢复子串</h2><p>TCP receiver：接收 datagrams，并将其按顺序排列、丢弃重复的、重新请求发送丢失的。</p><p>TCP sender：将大的数据流分成小的数据片（1460字节每片）。</p><p>实现：<code>Reassembler</code>，接收子串。</p><ol><li>子串包含字符串、以及其第一个字节的索引 within the larget stream.</li><li><strong>每个字节</strong>都有独立的索引，从 0 开始。</li><li>Reassembler 获取流的 <strong>下一个字节</strong> 后，就会把它写到输入端的 <code>ByteStream</code></li><li>customer 可以从其中读取内容。</li></ol><p>实现所有 <code>reassembler.hh</code> 中的 public 接口，不允许自己修改 public 接口。</p><h3 id=reassembler-内部应该存储什么>Reassembler 内部应该存储什么？</h3><p><code>insert</code> 通知 Reassembler 有新的字节流分片，以及其大小（字符串开头的索引）</p><p>需要解决三个问题：</p><ol><li>Bytes 是流中的 <em>next bytes</em>，直接写入。</li><li>Bytes 小于 stream 的可用容量范围内，但目前并不能写入，因为之前的 bytes 未知。<strong>暂存</strong>。</li><li>Bytes 超过了 stream 的可用容量范围。<strong>丢弃</strong>。Reassembler 不会存储任何不能被立刻写入的字节（包括太大、或者需要等待较早的字节已知的内容）</li></ol><p>宗旨是 <strong>节省内存容量</strong>。到达的不管是什么数据，我们都用以下的图来描述：</p><img src=image-20240513094207221.png alt=buffer style=zoom:50%><ul><li>红色：Reassembler 内部存储的字节</li><li>绿色：ByteStream 存储的字节</li><li>蓝色：已经被 popped 的字节</li></ul><hr><h3 id=faqs>FAQs</h3><ul><li><p>整个流的第一个字节的索引是什么？<strong>0</strong>.</p></li><li><p>我的实现的性能应该是？</p><p><strong>选择的数据结构非常重要。不要选择耗时的数据结构或者占据大量空间的结构，Reassembler 会是你的 TCP 实现的基础。你有很多选择。我们已经准备了 benchmark，任何大于 0.1 Gbps 的都可以通过。最大可以实现 10 Gbps 的 Reassembler。</strong></p></li><li><p>如何处理不连续的子串？</p><p><strong>你可以假设他们并不存在。就是说，你可以假设存在唯一的底层字节流，所有的子字符串都是其准确的切片。</strong></p></li><li><p>我可能用到？</p><p><strong>你可以使用任何标准库组件。特别地，我们希望你至少使用一种数据结构。</strong></p></li><li><p>什么时候将 bytes 写入流？</p><p><strong>尽可能快。唯一不能写入的情况就是字节流的前一个字节还没准备好。</strong></p></li><li><p>子串可能会重复吗？ <strong>是的</strong>。</p></li><li><p>我可以向 Reassembler 添加 private 成员函数吗？</p><p><strong>当然。子串可能以任何顺序到达，所以你的数据结构需要记住子串的顺序，直到他们被 push 进入 Stream，即在该子串的前面所有字节都写入完成。</strong></p></li><li><p>我们的 re-assembly 结构可以存储重复子串吗？</p><p><strong>不可以。即使你可以正确的实现，但是这样会打破节约内存的规则。</strong></p></li><li><p>Reassembler 会使用 ByteStream 的读端吗？</p><p><strong>不会。这是外部消费者做的。Reassembler 仅使用写端。</strong></p></li><li><p>你们预期的实现是多少？</p><p><strong>运行 ./scripts/lines-of-code 会打印你的代码行数。我们希望 Reassembler 在 50 - 60行左右（starter code 的基础上）</strong></p></li><li><p>更多 FAQs：https://cs144.github.io/lab_faq.html</p></li></ul><blockquote><p>经过几个小时的折磨，终于弄清楚了 <code>insert</code> 的逻辑。</p><p><code>bytes_pending()</code> 很简单，记录一下 pending 长度就行，主要的问题在于 <code>insert()</code> 的情况比较复杂。</p><p>按照 <code>first_index</code> 参数来区分情况，首先先去重，也就是 <code>first_index &lt; next_index_</code> 的情况，把重复的内容去掉。</p><p>去重后记得更新 <code>first_index</code>。</p><p>什么时候会写入呢？自己维护一个 <code>next_index</code>，然后 <code>first_index == next_index</code> 时就写入。</p><p>要注意容量吗？并不用，p0 我们实现的 byte stream 已经处理了。</p><p>此外，<code>next_index</code> 大概对应上图的 <code>first unassembled index</code>，而 <code>first_index</code> 是每个子串的 index。注意看图中红色的部分是断开的，那我们自然也不能用 <code>std::vector&lt;char></code> 来存储这些 bytes。我认为用 <code>std::map&lt;uint64_t, std::string></code> 存就可以，这样少一些复制。</p><p>什么时候会保存在 Reassembler 中呢？**写入操作不需要保存，不会出现写一半存一半的情况。**只有前面的内容没收到时才保存。</p><p>保存非常麻烦，要考虑容量问题。</p><p>容量足够的话就不说了，直接存入；</p><p>容量不够的话，要截断，怎么截断？</p><p><strong>容量，指的是 output stream 的容量，上面的图里画了。</strong> 截断时要留下 <code>first_index - next_index</code> 空间，这样才能够前文写入。</p><p>我的做法是，先在 map 中查找有没有 <code>first_index</code> 的存在，有的话，比较两个字符串的大小，留下长的。</p><p>之后就是遍历所有的结点，去掉重复的内容，怎么去除呢？</p><p>插入字符串的 <code>first_index ~ final_index</code> 期间的所有 map 结点都 erase 就好。</p><p>然后遍历所有的结点，把前一个结点和后一个结点重复的部分去除就行。</p><p>但是要注意插入的字符串已经是某个 pending 字符串子串的情况。这种情况直接返回。</p><p>记得要把 pending 的字符串写入，不会出现容量不够的情况，上面已经说了容量的计算了。然后把 <code>first_index &lt;= next_index_</code> 的内容全部写入，直接调用现有函数就行。</p><p>最后关于 <code>close</code> 写端，需要在写入所有的字节后关闭，但可能字节为 0，所以我用了个 <code>std::optional</code> 来记录，如果没有确定 last index，那么就是空，否则就不为空，之后判断就行。</p><p>这种解法已经是我能想到最快的了，跟字符串有关的操作全部都是 <code>O(1)</code>，没有复制开销，全部是移动，然后要遍历所有的结点。</p></blockquote><h2 id=开发和-debug-建议>开发和 Debug 建议</h2><ol><li><p>你可以通过 <code>cmake --build build --target check1</code> 来测试代码（编译之后）</p><blockquote><p>我寻思 <code>cmake --build</code> 不应该已经编译了吗，不过我好像也没怎么用过 cmake 的指令&mldr;</p></blockquote></li><li><p>重新读一次 <code>Lab 0 </code>的 using git 部分，确保代码最新。</p></li><li><p>说了一堆，意思就是让你代码内容明确，然后写点注释</p></li><li><p>保证 Modern C++</p></li><li><p>如果你编译卡住了又没法修复，你可以删除 <code>build</code> 目录，然后根目录下 <code>cmake -S . -B build</code></p></li></ol><h2 id=提交>提交</h2><ol><li><p>保证仅修改 <code>/src</code> 下的 <code>.hh</code> <code>.cc</code> 文件，不要修改 <code>public</code> 接口。</p></li><li><p>在你写作业之前，请按顺序运行：</p><ol><li><p>确保已经 commit 了所有的修改，可以用 <code>git status</code> 查看。</p></li><li><p><code>cmake --build build --target format</code></p><blockquote><p>VSCode + clang-format 大法好</p></blockquote></li><li><p><code>cmake --build build --target check1</code>（确保所有测试通过）</p></li><li><p>可选：<code>cmake --build build --target tidy</code> （改进代码）</p></li></ol></li><li><p>编写报告 <code>check1.md</code>，一行控制在 80 个字符以内，最好 20~50，这样容易读。</p><blockquote><p>太长了我又不写这个，不翻译。</p></blockquote></li><li><p>注意填写你做了几个小时，以及其他的评论</p></li><li><p>The mechanics of “how to turn it in” will be announced before the deadline.</p></li><li><p>Please let the course staff know ASAP of any problems at the lab session, or by posting a question on Ed. Good luck</p></li></ol><h2 id=源代码>源代码</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#pragma once
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;byte_stream.hh&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;map&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;optional&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>class</span> <span class=nc>Reassembler</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Construct Reassembler to write into given ByteStream.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>explicit</span> <span class=n>Reassembler</span><span class=p>(</span> <span class=n>ByteStream</span><span class=o>&amp;&amp;</span> <span class=n>output</span> <span class=p>)</span> <span class=o>:</span> <span class=n>output_</span><span class=p>(</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>output</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   * Insert a new substring to be reassembled into a ByteStream.
</span></span></span><span class=line><span class=cl><span class=cm>   *   `first_index`: the index of the first byte of the substring
</span></span></span><span class=line><span class=cl><span class=cm>   *   `data`: the substring itself
</span></span></span><span class=line><span class=cl><span class=cm>   *   `is_last_substring`: this substring represents the end of the stream
</span></span></span><span class=line><span class=cl><span class=cm>   *   `output`: a mutable reference to the Writer
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * The Reassembler&#39;s job is to reassemble the indexed substrings (possibly out-of-order
</span></span></span><span class=line><span class=cl><span class=cm>   * and possibly overlapping) back into the original ByteStream. As soon as the Reassembler
</span></span></span><span class=line><span class=cl><span class=cm>   * learns the next byte in the stream, it should write it to the output.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * If the Reassembler learns about bytes that fit within the stream&#39;s available capacity
</span></span></span><span class=line><span class=cl><span class=cm>   * but can&#39;t yet be written (because earlier bytes remain unknown), it should store them
</span></span></span><span class=line><span class=cl><span class=cm>   * internally until the gaps are filled in.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * The Reassembler should discard any bytes that lie beyond the stream&#39;s available capacity
</span></span></span><span class=line><span class=cl><span class=cm>   * (i.e., bytes that couldn&#39;t be written even if earlier gaps get filled in).
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * The Reassembler should close the stream after writing the last byte.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>insert</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>is_last_substring</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// How many bytes are stored in the Reassembler itself?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint64_t</span> <span class=nf>bytes_pending</span><span class=p>()</span> <span class=k>const</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Access output stream reader
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>Reader</span><span class=o>&amp;</span> <span class=n>reader</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>output_</span><span class=p>.</span><span class=n>reader</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>Reader</span><span class=o>&amp;</span> <span class=n>reader</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>output_</span><span class=p>.</span><span class=n>reader</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Access output stream writer, but const-only (can&#39;t write from outside)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=n>Writer</span><span class=o>&amp;</span> <span class=n>writer</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=n>insert_or_store</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>write_stored_str</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>write</span><span class=p>(</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>store</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=nf>truncate_head</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>old_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>data</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=n>ByteStream</span> <span class=n>output_</span><span class=p>;</span> <span class=c1>// the Reassembler writes to this ByteStream
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>map</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&gt;</span> <span class=n>pending_substr_</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>bytes_pending_</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>next_index_</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=o>&gt;</span> <span class=n>total_pushed_len_</span> <span class=p>{</span> <span class=n>std</span><span class=o>::</span><span class=n>nullopt</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;reassembler.hh&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;utility&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>insert</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>string</span> <span class=n>data</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>is_last_substring</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>is_last_substring</span> <span class=p>)</span> <span class=na>[[unlikely]]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>total_pushed_len_</span> <span class=o>=</span> <span class=n>first_index</span> <span class=o>+</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>insert_or_store</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>write_stored_str</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>total_pushed_len_</span><span class=p>.</span><span class=n>has_value</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>().</span><span class=n>bytes_pushed</span><span class=p>()</span> <span class=o>==</span> <span class=o>*</span><span class=n>total_pushed_len_</span> <span class=p>)</span> <span class=na>[[unlikely]]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>().</span><span class=n>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>insert_or_store</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>first_index</span> <span class=o>&lt;</span> <span class=n>next_index_</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>first_index</span> <span class=o>=</span> <span class=n>truncate_head</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>data</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>first_index</span> <span class=o>&gt;</span> <span class=n>next_index_</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>store</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>write</span><span class=p>(</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>write_stored_str</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=p>[</span><span class=n>first_index</span><span class=p>,</span> <span class=n>data</span><span class=p>]</span> <span class=o>:</span> <span class=n>pending_substr_</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>first_index</span> <span class=o>&lt;=</span> <span class=n>next_index_</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>buf</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>exchange</span><span class=p>(</span> <span class=n>data</span><span class=p>,</span> <span class=s>&#34;&#34;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>bytes_pending_</span> <span class=o>-=</span> <span class=n>buf</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>insert_or_store</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>buf</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>std</span><span class=o>::</span><span class=n>erase_if</span><span class=p>(</span> <span class=n>pending_substr_</span><span class=p>,</span> <span class=p>[](</span> <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>elem</span> <span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>elem</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>empty</span><span class=p>();</span> <span class=p>}</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>write</span><span class=p>(</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>().</span><span class=n>push</span><span class=p>(</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>next_index_</span> <span class=o>=</span> <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>().</span><span class=n>bytes_pushed</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>store</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>data</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=k>auto</span> <span class=n>len</span> <span class=o>=</span> <span class=n>output_</span><span class=p>.</span><span class=n>writer</span><span class=p>().</span><span class=n>available_capacity</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span> <span class=n>first_index</span> <span class=o>-</span> <span class=n>next_index_</span> <span class=p>);</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=n>len</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span> <span class=n>data</span><span class=p>.</span><span class=n>begin</span><span class=p>()</span> <span class=o>+</span> <span class=n>len</span><span class=p>,</span> <span class=n>data</span><span class=p>.</span><span class=n>end</span><span class=p>()</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>data</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span> <span class=p>)</span> <span class=na>[[unlikely]]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>pending_substr_</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span> <span class=p>)</span> <span class=na>[[unlikely]]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>bytes_pending_</span> <span class=o>+=</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>pending_substr_</span><span class=p>.</span><span class=n>emplace</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>final_index</span> <span class=o>=</span> <span class=n>first_index</span> <span class=o>+</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>pending_substr_</span><span class=p>.</span><span class=n>contains</span><span class=p>(</span> <span class=n>first_index</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>pending_substr_</span><span class=p>[</span><span class=n>first_index</span><span class=p>].</span><span class=n>length</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>mapped_data</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>exchange</span><span class=p>(</span> <span class=n>pending_substr_</span><span class=p>[</span><span class=n>first_index</span><span class=p>],</span> <span class=s>&#34;&#34;</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>bytes_pending_</span> <span class=o>-=</span> <span class=n>mapped_data</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>pending_substr_</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span> <span class=n>first_index</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>erase_if</span><span class=p>(</span> <span class=n>pending_substr_</span><span class=p>,</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span> <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>node</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>node</span><span class=p>.</span><span class=n>first</span> <span class=o>&gt;=</span> <span class=n>first_index</span> <span class=o>&amp;&amp;</span> <span class=n>node</span><span class=p>.</span><span class=n>first</span> <span class=o>+</span> <span class=n>node</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>&lt;=</span> <span class=n>final_index</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bytes_pending_</span> <span class=o>-=</span> <span class=n>node</span><span class=p>.</span><span class=n>second</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=p>[</span><span class=n>idx</span><span class=p>,</span> <span class=n>str</span><span class=p>]</span> <span class=o>:</span> <span class=n>pending_substr_</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>first_index</span> <span class=o>&gt;=</span> <span class=n>idx</span> <span class=o>&amp;&amp;</span> <span class=n>final_index</span> <span class=o>&lt;=</span> <span class=n>idx</span> <span class=o>+</span> <span class=n>str</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>bytes_pending_</span> <span class=o>+=</span> <span class=n>data</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>pending_substr_</span><span class=p>.</span><span class=n>emplace</span><span class=p>(</span> <span class=n>first_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span> <span class=n>data</span> <span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>begin_node</span> <span class=o>=</span> <span class=n>pending_substr_</span><span class=p>.</span><span class=n>lower_bound</span><span class=p>(</span> <span class=n>first_index</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>end_node</span> <span class=o>=</span> <span class=n>pending_substr_</span><span class=p>.</span><span class=n>upper_bound</span><span class=p>(</span> <span class=n>final_index</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>begin_node</span> <span class=o>!=</span> <span class=n>std</span><span class=o>::</span><span class=n>begin</span><span class=p>(</span> <span class=n>pending_substr_</span> <span class=p>)</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>begin_node</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>prev</span><span class=p>(</span> <span class=n>begin_node</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=k>auto</span> <span class=n>node</span> <span class=o>=</span> <span class=n>begin_node</span><span class=p>;</span> <span class=n>std</span><span class=o>::</span><span class=n>next</span><span class=p>(</span> <span class=n>node</span> <span class=p>)</span> <span class=o>!=</span> <span class=n>end_node</span><span class=p>;</span> <span class=o>++</span><span class=n>node</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>next_node</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>next</span><span class=p>(</span> <span class=n>node</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>this_final_index</span> <span class=o>=</span> <span class=n>node</span><span class=o>-&gt;</span><span class=n>first</span> <span class=o>+</span> <span class=n>node</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>auto</span> <span class=n>next_first_index</span> <span class=o>=</span> <span class=n>next_node</span><span class=o>-&gt;</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>this_final_index</span> <span class=o>&gt;=</span> <span class=n>next_first_index</span> <span class=p>)</span> <span class=na>[[likely]]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span> <span class=n>len</span> <span class=o>=</span> <span class=n>this_final_index</span> <span class=o>-</span> <span class=n>next_first_index</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bytes_pending_</span> <span class=o>-=</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span> <span class=n>node</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>.</span><span class=n>begin</span><span class=p>()</span> <span class=o>+</span> <span class=n>node</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>.</span><span class=n>length</span><span class=p>()</span> <span class=o>-</span> <span class=n>len</span><span class=p>,</span> <span class=n>node</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>.</span><span class=n>end</span><span class=p>()</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>truncate_head</span><span class=p>(</span> <span class=kt>uint64_t</span> <span class=n>old_index</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span> <span class=n>data</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>data</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span> <span class=mi>0</span><span class=p>,</span> <span class=n>next_index_</span> <span class=o>-</span> <span class=n>old_index</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>next_index_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=n>Reassembler</span><span class=o>::</span><span class=n>bytes_pending</span><span class=p>()</span> <span class=k>const</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>bytes_pending_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 May 12, 2024 00:00 UTC</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 Roses</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>